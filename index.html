<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ì„ìƒì„¼í„° íŒ€ ì„±í–¥ ë¶„ì„~ - ì‚¬ì£¼ Ã— MBTI</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Gowun+Batang:wght@400;700&family=Hi+Melody&display=swap" rel="stylesheet">
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    body {
      font-family: 'Gowun Batang', 'Hi Melody', serif;
      background: linear-gradient(160deg, #fff5f7 0%, #fce8ec 30%, #f8e8f4 60%, #f0e6fa 100%);
      min-height: 100vh;
      color: #5a4a5a;
      padding: 2rem;
      line-height: 1.7;
      position: relative;
    }
    body::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-image: radial-gradient(circle at 20% 30%, rgba(255, 182, 193, 0.15) 0%, transparent 50%),
                        radial-gradient(circle at 80% 70%, rgba(221, 160, 221, 0.12) 0%, transparent 50%);
      pointer-events: none;
      z-index: 0;
    }
    .container {
      max-width: 640px;
      margin: 0 auto;
      position: relative;
      z-index: 1;
    }
    h1 {
      text-align: center;
      margin-bottom: 2rem;
      font-size: 2rem;
      font-weight: 700;
      font-family: 'Hi Melody', cursive;
      color: #d4849c;
      text-shadow: 1px 1px 0 rgba(255,255,255,0.8);
    }
    h1::before { content: 'ğŸŒ¸ '; }
    h1::after { content: ' ğŸŒ¸'; }
    .card {
      background: rgba(255, 255, 255, 0.85);
      border: 2px solid rgba(255, 182, 193, 0.4);
      border-radius: 24px;
      padding: 1.5rem;
      margin-bottom: 1.5rem;
      box-shadow: 0 4px 20px rgba(212, 132, 156, 0.12);
    }
    .form-row {
      display: flex;
      gap: 1rem;
      margin-bottom: 1rem;
      flex-wrap: wrap;
    }
    .form-group {
      flex: 1;
      min-width: 140px;
    }
    label {
      display: block;
      font-size: 0.9rem;
      color: #8b7a8b;
      margin-bottom: 0.35rem;
    }
    input, select {
      width: 100%;
      padding: 0.65rem 0.9rem;
      border: 2px solid rgba(212, 132, 156, 0.3);
      border-radius: 16px;
      background: #fff;
      color: #5a4a5a;
      font-size: 0.95rem;
      font-family: inherit;
    }
    input:focus, select:focus {
      outline: none;
      border-color: #d4849c;
      box-shadow: 0 0 0 3px rgba(212, 132, 156, 0.15);
    }
    input::placeholder {
      color: #b8a8b8;
    }
    select option {
      background: #fff;
      color: #5a4a5a;
    }
    .mbti-row {
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
    }
    .mbti-row select {
      flex: 1;
      min-width: 70px;
    }
    button {
      padding: 0.7rem 1.3rem;
      border: none;
      border-radius: 20px;
      font-size: 0.95rem;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.25s;
      font-family: inherit;
    }
    .btn-primary {
      background: linear-gradient(135deg, #f4a6b8, #e899b0);
      color: #fff;
      margin-right: 0.5rem;
      margin-bottom: 0.5rem;
      box-shadow: 0 3px 12px rgba(212, 132, 156, 0.35);
    }
    .btn-primary:hover {
      transform: translateY(-2px) scale(1.02);
      box-shadow: 0 6px 20px rgba(212, 132, 156, 0.45);
    }
    .btn-secondary {
      background: #fff;
      color: #c97a94;
      border: 2px solid rgba(212, 132, 156, 0.5);
    }
    .btn-secondary:hover {
      background: rgba(255, 182, 193, 0.25);
      border-color: #d4849c;
    }
    .result-box {
      background: linear-gradient(135deg, #fff9fb 0%, #fef5f8 100%);
      border: 2px dashed rgba(212, 132, 156, 0.35);
      border-radius: 20px;
      padding: 1.25rem;
      margin-top: 1rem;
      white-space: pre-line;
      min-height: 60px;
      color: #5a4a5a;
    }
    .team-names {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      margin-top: 0.5rem;
    }
    .team-name-tag {
      display: inline-flex;
      align-items: center;
      gap: 0.3rem;
      background: linear-gradient(135deg, #ffd6e0, #ffe4ec);
      color: #b85c7a;
      padding: 0.4rem 0.5rem 0.4rem 0.9rem;
      border-radius: 20px;
      font-size: 0.9rem;
      font-weight: 600;
      border: 1px solid rgba(212, 132, 156, 0.3);
      position: relative;
    }
    .tag-delete {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 1.1rem;
      height: 1.1rem;
      padding: 0;
      border: none;
      border-radius: 50%;
      background: rgba(184, 92, 122, 0.25);
      color: #b85c7a;
      font-size: 1rem;
      line-height: 1;
      cursor: pointer;
      transition: all 0.2s;
    }
    .tag-delete:hover {
      background: rgba(184, 92, 122, 0.45);
    }
    .api-key-hint {
      font-size: 0.8rem;
      color: #9a8a9a;
      margin-top: 0.5rem;
    }
    .loading {
      color: #b8a8b8;
      font-style: italic;
    }
    .error {
      color: #d4607a;
      font-size: 0.9rem;
    }
    .section-title {
      font-family: 'Hi Melody', cursive;
      font-size: 1.15rem;
      color: #c97a94;
      margin-bottom: 0.5rem;
    }
    .my-result-inner {
      display: flex;
      gap: 1.25rem;
      align-items: flex-start;
    }
    .ohang-illust {
      flex-shrink: 0;
      width: 100px;
      height: 100px;
    }
    .ohang-illust svg {
      width: 100%;
      height: 100%;
      display: block;
    }
    .my-result-text {
      flex: 1;
      white-space: pre-line;
    }
    .team-comp-table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 1.25rem;
      font-size: 0.9rem;
    }
    .team-comp-table th,
    .team-comp-table td {
      border: 1px solid rgba(212, 132, 156, 0.35);
      padding: 0.5rem 0.7rem;
      text-align: left;
    }
    .team-comp-table th {
      background: linear-gradient(135deg, #ffe4ec, #ffd6e0);
      color: #b85c7a;
      font-weight: 600;
    }
    .team-comp-table tr:nth-child(even) {
      background: rgba(255, 249, 251, 0.6);
    }
    .team-comp-table tr:hover {
      background: rgba(255, 230, 240, 0.5);
    }
    .team-comp-narrative {
      white-space: pre-line;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ì„ìƒì„¼í„° íŒ€ ì„±í–¥ ë¶„ì„~ Â· ì‚¬ì£¼ Ã— MBTI</h1>

    <!-- ê¸°ë³¸ ì •ë³´ -->
    <div class="card">
      <h3 class="section-title" style="margin-bottom: 1rem;">ê¸°ë³¸ ì •ë³´</h3>
      <div class="form-row">
        <div class="form-group">
          <label>ì´ë¦„</label>
          <input type="text" id="userName" placeholder="í™ê¸¸ë™">
        </div>
        <div class="form-group">
          <label>íŒ€ëª…</label>
          <input type="text" id="teamName" placeholder="ì˜ˆ: ê°œë°œíŒ€">
        </div>
      </div>

      <!-- ì‚¬ì£¼: ìƒë…„ì›”ì¼ì‹œ -->
      <h4 style="margin: 1rem 0 0.5rem; font-size: 1rem; color: #8b7a8b;">ì‚¬ì£¼ ì •ë³´</h4>
      <div class="form-row">
        <div class="form-group">
          <label>ìƒë…„</label>
          <input type="number" id="birthYear" placeholder="1990" min="1900" max="2100">
        </div>
        <div class="form-group">
          <label>ìƒì›”</label>
          <input type="number" id="birthMonth" placeholder="1" min="1" max="12">
        </div>
        <div class="form-group">
          <label>ìƒì¼</label>
          <input type="number" id="birthDay" placeholder="15" min="1" max="31">
        </div>
        <div class="form-group">
          <label>íƒœì–´ë‚œ ì‹œê°„</label>
          <select id="birthHour">
            <option value="">ëª¨ë¦„</option>
            <option value="ìì‹œ">ìì‹œ (23:00~01:00)</option>
            <option value="ì¶•ì‹œ">ì¶•ì‹œ (01:00~03:00)</option>
            <option value="ì¸ì‹œ">ì¸ì‹œ (03:00~05:00)</option>
            <option value="ë¬˜ì‹œ">ë¬˜ì‹œ (05:00~07:00)</option>
            <option value="ì§„ì‹œ">ì§„ì‹œ (07:00~09:00)</option>
            <option value="ì‚¬ì‹œ">ì‚¬ì‹œ (09:00~11:00)</option>
            <option value="ì˜¤ì‹œ">ì˜¤ì‹œ (11:00~13:00)</option>
            <option value="ë¯¸ì‹œ">ë¯¸ì‹œ (13:00~15:00)</option>
            <option value="ì‹ ì‹œ">ì‹ ì‹œ (15:00~17:00)</option>
            <option value="ìœ ì‹œ">ìœ ì‹œ (17:00~19:00)</option>
            <option value="ìˆ ì‹œ">ìˆ ì‹œ (19:00~21:00)</option>
            <option value="í•´ì‹œ">í•´ì‹œ (21:00~23:00)</option>
          </select>
        </div>
      </div>

      <!-- MBTI -->
      <h4 style="margin: 1rem 0 0.5rem; font-size: 1rem; color: #8b7a8b;">MBTI</h4>
      <div class="mbti-row">
        <select id="mbti1">
          <option value="">ì„ íƒ</option>
          <option value="I">I</option>
          <option value="E">E</option>
        </select>
        <select id="mbti2">
          <option value="">ì„ íƒ</option>
          <option value="N">N</option>
          <option value="S">S</option>
        </select>
        <select id="mbti3">
          <option value="">ì„ íƒ</option>
          <option value="T">T</option>
          <option value="F">F</option>
        </select>
        <select id="mbti4">
          <option value="">ì„ íƒ</option>
          <option value="J">J</option>
          <option value="P">P</option>
        </select>
      </div>
    </div>

    <!-- ë²„íŠ¼ ì˜ì—­ -->
    <div class="card">
      <div style="margin-bottom: 1rem;">
        <button type="button" class="btn-primary" id="btnMyResult">ë‚´ ê²°ê³¼ë³´ê¸°</button>
        <button type="button" class="btn-secondary" id="btnAccumulate">íŒ€ì›ê°’ìœ¼ë¡œ ë‚´ì •ë³´ ëˆ„ì í•˜ê¸°</button>
      </div>
      <button type="button" class="btn-primary" id="btnTeamCompatibility">ìš°ë¦¬ íŒ€ì˜ ì„±í–¥ ê¶í•©</button>
    </div>

    <!-- ë‚´ ê²°ê³¼ -->
    <div class="card">
      <h3 class="section-title" style="margin-bottom: 0.5rem;">ë‚´ ì„±í–¥ ê²°ê³¼</h3>
      <div id="myResult" class="result-box">ë‚´ ê²°ê³¼ê°€ ì—¬ê¸°ì— í‘œì‹œë¼ìš” ğŸ’•</div>
    </div>

    <!-- ëˆ„ì ëœ íŒ€ì› -->
    <div class="card">
      <h3 class="section-title" style="margin-bottom: 0.5rem;">ëˆ„ì ëœ íŒ€ì› ì´ë¦„</h3>
      <div id="accumulatedNames" class="team-names">ì•„ì§ ëˆ„ì ëœ íŒ€ì›ì´ ì—†ìŠµë‹ˆë‹¤.</div>
    </div>

    <!-- íŒ€ ê¶í•© ê²°ê³¼ -->
    <div class="card">
      <h3 class="section-title" style="margin-bottom: 0.5rem;">ìš°ë¦¬ íŒ€ì˜ ì„±í–¥ ê¶í•©</h3>
      <div id="teamCompatibility" class="result-box">íŒ€ì› ì •ë³´ë¥¼ ëˆ„ì í•œ í›„ 'ìš°ë¦¬ íŒ€ì˜ ì„±í–¥ ê¶í•©' ë²„íŠ¼ì„ ëˆŒëŸ¬ë³´ì„¸ìš” âœ¨</div>
    </div>

    <!-- API í‚¤ ì„¤ì • (ê°œë°œìš© - ì‹¤ì œ ë°°í¬ ì‹œ ì„œë²„ì—ì„œ ì²˜ë¦¬ ê¶Œì¥) -->
    <div class="card">
      <label>Gemini API í‚¤ <span style="color:#666">(í•„ìš” ì‹œ ì…ë ¥)</span></label>
      <input type="password" id="apiKey" placeholder="API í‚¤ë¥¼ ì…ë ¥í•˜ì„¸ìš” (ì„ íƒ)">
      <p class="api-key-hint">Google AI Studio(aistudio.google.com)ì—ì„œ ë¬´ë£Œ API í‚¤ ë°œê¸‰ ê°€ëŠ¥. ë¸Œë¼ìš°ì €ì— ë…¸ì¶œë˜ë¯€ë¡œ ë¡œì»¬/ê°œë°œìš©ìœ¼ë¡œë§Œ ì‚¬ìš©í•˜ì„¸ìš”.</p>
    </div>
  </div>

  <script>
    // localStorage í‚¤
    const STORAGE_KEY = 'team_members_data';

    // ì˜¤í–‰ë³„ ê·€ì—¬ìš´ SVG ì¼ëŸ¬ìŠ¤íŠ¸ (ëª©/í™”/í† /ê¸ˆ/ìˆ˜)
    const OHANG_ILLUST = {
      ìˆ˜: '<svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"><defs><linearGradient id="wg" x1="0%" y1="0%" x2="0%" y2="100%"><stop offset="0%" style="stop-color:#87CEEB"/><stop offset="100%" style="stop-color:#B0E0E6"/></linearGradient></defs><ellipse cx="50" cy="55" rx="35" ry="25" fill="url(#wg)" opacity="0.9"/><path d="M20 55 Q35 45 50 55 Q65 65 80 55" stroke="#5DADE2" stroke-width="3" fill="none" stroke-linecap="round"/><ellipse cx="30" cy="35" rx="8" ry="10" fill="#AED6F1"/><ellipse cx="70" cy="40" rx="6" ry="8" fill="#AED6F1"/><circle cx="50" cy="25" r="6" fill="#D4E6F1"/></svg>',
      í™”: '<svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"><defs><linearGradient id="fg" x1="50%" y1="100%" x2="50%" y2="0%"><stop offset="0%" style="stop-color:#F39C12"/><stop offset="100%" style="stop-color:#E74C3C"/></linearGradient></defs><path d="M50 20 Q60 35 55 50 Q50 70 50 85 Q50 70 45 50 Q40 35 50 20" fill="url(#fg)"/><path d="M35 45 Q45 40 50 50 Q45 55 35 50" fill="#F5B041" opacity="0.8"/><path d="M65 48 Q55 42 50 52 Q55 58 65 52" fill="#F5B041" opacity="0.8"/><circle cx="50" cy="35" r="5" fill="#FDEBD0"/></svg>',
      ëª©: '<svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"><defs><linearGradient id="mg" x1="0%" y1="100%" x2="0%" y2="0%"><stop offset="0%" style="stop-color:#7DCEA0"/><stop offset="100%" style="stop-color:#52BE80"/></linearGradient></defs><ellipse cx="50" cy="70" rx="15" ry="8" fill="#8B7355"/><path d="M50 70 L50 25" stroke="#8B7355" stroke-width="6" stroke-linecap="round"/><ellipse cx="50" cy="35" rx="28" ry="25" fill="url(#mg)"/><ellipse cx="35" cy="45" rx="12" ry="10" fill="#58D68D" opacity="0.9"/><ellipse cx="65" cy="40" rx="10" ry="12" fill="#58D68D" opacity="0.9"/><ellipse cx="50" cy="28" rx="8" ry="10" fill="#82E0AA"/></svg>',
      ê¸ˆ: '<svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"><defs><linearGradient id="kig" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" style="stop-color:#F4D03F"/><stop offset="100%" style="stop-color:#D4AC0D"/></linearGradient></defs><polygon points="50 15 65 40 50 35 35 40" fill="url(#kig)"/><polygon points="50 35 70 55 50 50 30 55" fill="url(#kig)" opacity="0.9"/><polygon points="50 50 60 75 50 70 40 75" fill="url(#kig)" opacity="0.85"/><circle cx="50" cy="45" r="8" fill="#FCF3CF"/></svg>',
      í† : '<svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"><defs><linearGradient id="tg" x1="0%" y1="100%" x2="0%" y2="0%"><stop offset="0%" style="stop-color:#BB8FCE"/><stop offset="100%" style="stop-color:#D7BDE2"/></linearGradient></defs><path d="M20 75 Q35 55 50 65 Q65 55 80 75 L80 95 L20 95 Z" fill="url(#tg)"/><ellipse cx="50" cy="50" rx="25" ry="18" fill="#E8DAEF"/><path d="M30 85 Q50 70 70 85" stroke="#A569BD" stroke-width="2" fill="none" opacity="0.6"/><circle cx="40" cy="45" r="5" fill="#D2B4DE"/><circle cx="60" cy="48" r="4" fill="#D2B4DE"/></svg>'
    };

    // MBTI ê°’ ìˆ˜ì§‘
    function getMBTI() {
      const m1 = document.getElementById('mbti1').value;
      const m2 = document.getElementById('mbti2').value;
      const m3 = document.getElementById('mbti3').value;
      const m4 = document.getElementById('mbti4').value;
      if (!m1 || !m2 || !m3 || !m4) return null;
      return m1 + m2 + m3 + m4;
    }

    // ì‚¬ì£¼ ì •ë³´ ìˆ˜ì§‘
    function getSajuInfo() {
      const year = document.getElementById('birthYear').value;
      const month = document.getElementById('birthMonth').value;
      const day = document.getElementById('birthDay').value;
      const hour = document.getElementById('birthHour').value;
      return { year, month, day, hour };
    }

    // Gemini API í˜¸ì¶œ
    async function callGemini(prompt) {
      const apiKey = document.getElementById('apiKey').value?.trim();
      if (!apiKey) {
        throw new Error('Gemini API í‚¤ë¥¼ ì…ë ¥í•´ ì£¼ì„¸ìš”. (Google AI Studioì—ì„œ ë°œê¸‰ ê°€ëŠ¥)');
      }
      const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
      const res = await fetch(url, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          contents: [{
            parts: [{ text: prompt }]
          }],
          generationConfig: {
            temperature: 0.8,
            maxOutputTokens: 2048,
          }
        })
      });
      if (!res.ok) {
        const err = await res.json();
        throw new Error(err.error?.message || 'API í˜¸ì¶œ ì‹¤íŒ¨');
      }
      const data = await res.json();
      return data.candidates?.[0]?.content?.parts?.[0]?.text?.trim() || 'ì‘ë‹µì„ ìƒì„±í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.';
    }

    // ë‚´ ê²°ê³¼ë³´ê¸°
    document.getElementById('btnMyResult').addEventListener('click', async () => {
      const box = document.getElementById('myResult');
      const mbti = getMBTI();
      const saju = getSajuInfo();

      if (!mbti) {
        box.innerHTML = '<span class="error">MBTI 4ê°€ì§€ ì„±í–¥ì„ ëª¨ë‘ ì„ íƒí•´ ì£¼ì„¸ìš”.</span>';
        return;
      }
      if (!saju.year || !saju.month || !saju.day) {
        box.innerHTML = '<span class="error">ìƒë…„, ìƒì›”, ìƒì¼ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”.</span>';
        return;
      }

      box.innerHTML = '<span class="loading">âœ¨ ì„±í–¥ì„ ë¶„ì„í•˜ê³  ìˆì–´ìš”... ì ì‹œë§Œ ê¸°ë‹¤ë ¤ ì£¼ì„¸ìš”</span>';

      const hourText = saju.hour ? `${saju.hour}` : 'ëª¨ë¦„';
      const prompt = `ë‹¹ì‹ ì€ ì‚¬ì£¼íŒ”ìì™€ MBTIë¥¼ ëª¨ë‘ ì˜ ì•„ëŠ” ì „ë¬¸ê°€ì…ë‹ˆë‹¤.
ë‹¤ìŒ ì •ë³´ë¥¼ ë°”íƒ•ìœ¼ë¡œ ë‘ ê°€ì§€ë¥¼ ì‘ì„±í•´ ì£¼ì„¸ìš”.

1) ì´ ì‚¬ëŒì˜ í†µí•© ì„±í–¥ì„ 6~7ì¤„ ì •ë„ë¡œ ìì—°ìŠ¤ëŸ¬ìš´ í•œêµ­ì–´ë¡œ ì„¤ëª…. ì‚¬ì£¼ì™€ MBTIë¥¼ ì—°ê²°í•œ ì„±ê²©/ì„±í–¥ ì„¤ëª….

2) ì‚¬ì£¼íŒ”ìì˜ ìŒì–‘ì˜¤í–‰(ëª©/í™”/í† /ê¸ˆ/ìˆ˜) ì¤‘ ì´ ì‚¬ëŒì—ê²Œ ê°€ì¥ ê°•í•˜ê²Œ ë‚˜íƒ€ë‚˜ëŠ” ì˜¤í–‰ í•˜ë‚˜ë¥¼ íŒë‹¨í•´ ì£¼ì„¸ìš”.
ë°˜ë“œì‹œ ë§ˆì§€ë§‰ ì¤„ì— ì •í™•íˆ ë‹¤ìŒ í˜•ì‹ìœ¼ë¡œë§Œ ì‘ì„±: ã€ê°€ì¥ ê°•í•œ ì˜¤í–‰: ëª©ã€‘ ë˜ëŠ” ã€ê°€ì¥ ê°•í•œ ì˜¤í–‰: í™”ã€‘ ë˜ëŠ” ã€ê°€ì¥ ê°•í•œ ì˜¤í–‰: í† ã€‘ ë˜ëŠ” ã€ê°€ì¥ ê°•í•œ ì˜¤í–‰: ê¸ˆã€‘ ë˜ëŠ” ã€ê°€ì¥ ê°•í•œ ì˜¤í–‰: ìˆ˜ã€‘

- ìƒë…„: ${saju.year}, ìƒì›”: ${saju.month}, ìƒì¼: ${saju.day}, íƒœì–´ë‚œ ì‹œê°„: ${hourText}
- MBTI: ${mbti}

ì¹œê·¼í•˜ê³  ì´í•´í•˜ê¸° ì‰¬ìš´ ë¬¸ì¥ìœ¼ë¡œ ì‘ì„±í•´ ì£¼ì„¸ìš”.`;

      try {
        const rawResult = await callGemini(prompt);
        const match = rawResult.match(/ã€ê°€ì¥ ê°•í•œ ì˜¤í–‰: (ëª©|í™”|í† |ê¸ˆ|ìˆ˜)ã€‘/);
        const ohang = (match && OHANG_ILLUST[match[1]]) ? match[1] : null;
        const textOnly = rawResult.replace(/\s*ã€ê°€ì¥ ê°•í•œ ì˜¤í–‰: (ëª©|í™”|í† |ê¸ˆ|ìˆ˜)ã€‘\s*$/, '').trim();
        const illustHtml = ohang ? `<div class="ohang-illust">${OHANG_ILLUST[ohang]}</div>` : '';
        box.innerHTML = illustHtml ? `<div class="my-result-inner">${illustHtml}<div class="my-result-text">${textOnly.replace(/\n/g, '<br>')}</div></div>` : `<div class="my-result-text">${textOnly.replace(/\n/g, '<br>')}</div>`;
      } catch (e) {
        box.innerHTML = `<span class="error">ì˜¤ë¥˜: ${e.message}</span>`;
      }
    });

    // íŒ€ì› ì •ë³´ ëˆ„ì 
    document.getElementById('btnAccumulate').addEventListener('click', () => {
      const name = document.getElementById('userName').value?.trim();
      const team = document.getElementById('teamName').value?.trim();
      const mbti = getMBTI();
      const saju = getSajuInfo();

      if (!name) {
        alert('ì´ë¦„ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”.');
        return;
      }
      if (!team) {
        alert('íŒ€ëª…ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”.');
        return;
      }
      if (!mbti) {
        alert('MBTI 4ê°€ì§€ ì„±í–¥ì„ ëª¨ë‘ ì„ íƒí•´ ì£¼ì„¸ìš”.');
        return;
      }
      if (!saju.year || !saju.month || !saju.day) {
        alert('ìƒë…„, ìƒì›”, ìƒì¼ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”.');
        return;
      }

      let list = [];
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (raw) list = JSON.parse(raw);
      } catch (e) {
        list = [];
      }

      const key = `${team}::${name}`;
      const idx = list.findIndex(x => x.key === key);
      const entry = {
        key,
        name,
        team,
        mbti,
        saju,
        addedAt: new Date().toISOString()
      };
      if (idx >= 0) list[idx] = entry;
      else list.push(entry);

      localStorage.setItem(STORAGE_KEY, JSON.stringify(list));

      updateAccumulatedNames(team);
      alert(`"${name}"ë‹˜ì˜ ì •ë³´ê°€ ëˆ„ì ë˜ì—ˆìŠµë‹ˆë‹¤.`);
    });

    function updateAccumulatedNames(teamFilter) {
      const container = document.getElementById('accumulatedNames');
      let list = [];
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (raw) list = JSON.parse(raw);
      } catch (e) {}
      if (teamFilter) {
        list = list.filter(x => x.team === teamFilter);
      }
      if (list.length === 0) {
        container.innerHTML = teamFilter
          ? `"${teamFilter}" íŒ€ì—ëŠ” ì•„ì§ ëˆ„ì ëœ íŒ€ì›ì´ ì—†ì–´ìš”`
          : 'ì•„ì§ ëˆ„ì ëœ íŒ€ì›ì´ ì—†ì–´ìš”';
        return;
      }
      container.innerHTML = list.map(x => `<span class="team-name-tag">${x.name}<button type="button" class="tag-delete" data-key="${x.key}" title="ì‚­ì œ">Ã—</button></span>`).join('');
    }

    // ë§ˆí¬ë‹¤ìš´ í‘œë¥¼ HTML í…Œì´ë¸”ë¡œ ë³€í™˜
    function parseTeamResult(text) {
      const lines = text.split('\n');
      const tableLines = [];
      let i = 0;
      while (i < lines.length && lines[i].includes('|')) {
        const line = lines[i];
        if (/[ê°€-í£a-zA-Z0-9]/.test(line)) tableLines.push(line);
        i++;
      }
      let tableHtml = '';
      if (tableLines.length >= 1) {
        const headerCells = tableLines[0].split('|').filter(c => c.trim());
        const headerRow = '<tr>' + headerCells.map(c => `<th>${c.trim()}</th>`).join('') + '</tr>';
        let bodyRows = '';
        for (let j = 1; j < tableLines.length; j++) {
          const cells = tableLines[j].split('|').filter(c => c.trim());
          if (cells.length >= 1) bodyRows += '<tr>' + cells.map(c => `<td>${c.trim()}</td>`).join('') + '</tr>';
        }
        tableHtml = `<table class="team-comp-table"><thead>${headerRow}</thead><tbody>${bodyRows}</tbody></table>`;
      }
      const narrativeStart = lines.findIndex((l, idx) => idx >= i && l.trim().length > 0);
      const narrative = narrativeStart >= 0 ? lines.slice(narrativeStart).join('\n').trim() : '';
      const narrativeHtml = narrative ? `<div class="team-comp-narrative">${narrative.replace(/\n/g, '<br>')}</div>` : '';
      return tableHtml + narrativeHtml;
    }

    // íŒ€ ê¶í•© ë³´ê¸°
    document.getElementById('btnTeamCompatibility').addEventListener('click', async () => {
      const box = document.getElementById('teamCompatibility');
      const team = document.getElementById('teamName').value?.trim();

      let list = [];
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (raw) list = JSON.parse(raw);
      } catch (e) {}

      if (team) list = list.filter(x => x.team === team);
      if (list.length < 2) {
        box.innerHTML = '<span class="error">íŒ€ ê¶í•©ì„ ë³´ë ¤ë©´ ê°™ì€ íŒ€ì›ì´ 2ëª… ì´ìƒ ëˆ„ì ë˜ì–´ ìˆì–´ì•¼ í•©ë‹ˆë‹¤. íŒ€ëª…ì„ ì…ë ¥í•˜ê³  íŒ€ì› ì •ë³´ë¥¼ ëˆ„ì í•´ ì£¼ì„¸ìš”.</span>';
        return;
      }

      box.innerHTML = '<span class="loading">âœ¨ íŒ€ ê¶í•©ì„ ë¶„ì„í•˜ê³  ìˆì–´ìš”... ì ì‹œë§Œ ê¸°ë‹¤ë ¤ ì£¼ì„¸ìš”</span>';

      const membersDesc = list.map((m, i) => {
        const h = m.saju.hour ? m.saju.hour : 'ëª¨ë¦„';
        return `${i + 1}. ${m.name}: ì‚¬ì£¼ ${m.saju.year}ë…„ ${m.saju.month}ì›” ${m.saju.day}ì¼ ${h}, MBTI ${m.mbti}`;
      }).join('\n');

      const prompt = `ë‹¹ì‹ ì€ ì‚¬ì£¼íŒ”ìì™€ MBTIë¥¼ ëª¨ë‘ ì˜ ì•„ëŠ” íŒ€ ë¹Œë”© ì „ë¬¸ê°€ì…ë‹ˆë‹¤.
ë‹¤ìŒ íŒ€ì›ë“¤ì˜ ì •ë³´ë¥¼ ë°”íƒ•ìœ¼ë¡œ, ë°˜ë“œì‹œ ì•„ë˜ ìˆœì„œì™€ í˜•ì‹ìœ¼ë¡œ ì‘ì„±í•´ ì£¼ì„¸ìš”.

ã€1ë‹¨ê³„ã€‘ê°€ì¥ ë¨¼ì € ìš”ì•½ í‘œë¥¼ ì‘ì„±í•˜ì„¸ìš”.
- ë§ˆí¬ë‹¤ìš´ í‘œ í˜•ì‹ìœ¼ë¡œ ì‘ì„±. ì»¬ëŸ¼: ì´ë¦„ | MBTI | ì—ë„ˆì§€íƒ€ì… | ì¡°ì§ ë‚´ ì—­í•  ê¸°ì§ˆ
- ì—ë„ˆì§€íƒ€ì…: ì‚¬ì£¼ ì˜¤í–‰(ëª©/í™”/í† /ê¸ˆ/ìˆ˜) ë˜ëŠ” MBTI E/I ë“±ì—ì„œ íŒë‹¨í•œ ê¸°ì§ˆì„ ê°„ë‹¨íˆ (ì˜ˆ: ìˆ˜(æ°´)í˜•, ì™¸í–¥Â·ì§ê´€í˜•)
- ì¡°ì§ ë‚´ ì—­í•  ê¸°ì§ˆ: ê° íŒ€ì›ì—ê²Œ ì–´ìš¸ë¦¬ëŠ” ì—­í• ì„ í•œ ì¤„ë¡œ (ì˜ˆ: ì•„ì´ë””ì–´ ë¦¬ë“œ, ì„¸ë¶€ ì‹¤í–‰ ë‹´ë‹¹)

ì˜ˆì‹œ:
| ì´ë¦„ | MBTI | ì—ë„ˆì§€íƒ€ì… | ì¡°ì§ ë‚´ ì—­í•  ê¸°ì§ˆ |
|------|------|------------|------------------|
| í™ê¸¸ë™ | ENFP | í™”(ç«)í˜• | ì•„ì´ë””ì–´Â·ë¦¬ë“œ |
| ê¹€ì² ìˆ˜ | ISTJ | í† (åœŸ)í˜• | ì„¸ë¶€ ì‹¤í–‰ |

ã€2ë‹¨ê³„ã€‘í‘œ ë‹¤ìŒì— ë¹ˆ ì¤„ í•˜ë‚˜ ë‘” ë’¤, ë¹„ìŠ·í•œ ì„±í–¥ë¼ë¦¬ ë¬¶ì€ ê²°ê³¼ë¥¼ ì„œìˆ í•´ ì£¼ì„¸ìš”.
- MBTIÂ·ì‚¬ì£¼ë¥¼ ê¸°ì¤€ìœ¼ë¡œ ë¹„ìŠ·í•œ ì„±í–¥ì˜ íŒ€ì›ë“¤ì„ ê·¸ë£¹ìœ¼ë¡œ ë¬¶ê³ , ê° ê·¸ë£¹ì„ 2~4ì¤„ ì •ë„ë¡œ ìì—°ìŠ¤ëŸ½ê²Œ ì„¤ëª…í•´ ì£¼ì„¸ìš”.
- ê¸ì •ì ì¸ ì¡°í•©(ì–´ë–¤ ì¡°í•©ì´ ì‹œë„ˆì§€ë¥¼ ë‚¼ ìˆ˜ ìˆëŠ”ì§€)ë„ ê°„ëµíˆ í¬í•¨í•´ ì£¼ì„¸ìš”.

íŒ€ì› ì •ë³´:
${membersDesc}`;

      try {
        const rawResult = await callGemini(prompt);
        const parsed = parseTeamResult(rawResult);
        box.innerHTML = parsed;
      } catch (e) {
        box.innerHTML = `<span class="error">ì˜¤ë¥˜: ${e.message}</span>`;
      }
    });

    // íŒ€ëª… ë³€ê²½ ì‹œ ëˆ„ì  íŒ€ì› ëª©ë¡ ê°±ì‹ 
    document.getElementById('teamName').addEventListener('blur', () => {
      const team = document.getElementById('teamName').value?.trim();
      updateAccumulatedNames(team);
    });

    // ëˆ„ì  íŒ€ì› ì‚­ì œ (x ë²„íŠ¼)
    document.getElementById('accumulatedNames').addEventListener('click', (e) => {
      const btn = e.target.closest('.tag-delete');
      if (!btn) return;
      const key = btn.getAttribute('data-key');
      if (!key) return;
      let list = [];
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (raw) list = JSON.parse(raw);
      } catch (err) {}
      list = list.filter(x => x.key !== key);
      localStorage.setItem(STORAGE_KEY, JSON.stringify(list));
      const team = document.getElementById('teamName').value?.trim();
      updateAccumulatedNames(team);
    });

    // ì´ˆê¸° ë¡œë“œ ì‹œ (íŒ€ëª… ì—†ìœ¼ë©´ ì „ì²´ í‘œì‹œ)
    updateAccumulatedNames();
  </script>
</body>
</html>
